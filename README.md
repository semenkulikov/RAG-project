# RAG Система Генерации Юридических Документов

## Описание проекта

Система для автоматической генерации юридических документов (исковые заявления, апелляционные и кассационные жалобы) с мотивировочной частью на основе судебной практики Верховного Суда РФ. Использует архитектуру Retrieval-Augmented Generation (RAG) для поиска релевантных судебных решений и генерации качественных процессуальных документов.

## Проблема

Предыдущая попытка создания локальной модели для генерации юридических документов провалилась из-за:
- Недостатка обучающих данных
- Недостаточного обучения модели
- Некорректных ответов (модель просто повторяла введенный текст)
- Отсутствия правовой мотивировки
- Неправильного применения правовых норм

## Решение

RAG-система, которая:
1. **Ищет** релевантные судебные решения из базы 40,000 документов ВС РФ
2. **Анализирует** правовые позиции и мотивировки
3. **Генерирует** структурированные юридические документы с обоснованием

## Техническое задание

### Цели системы

**Основная цель:** Создать систему, которая по описанию обстоятельств дела генерирует готовые к подаче юридические документы с качественной мотивировочной частью.

**Конкретные задачи:**
- Принимать описание фактических обстоятельств дела
- Находить 3-5 наиболее релевантных судебных решений ВС РФ
- Генерировать исковые заявления, апелляционные/кассационные жалобы
- Обеспечивать ссылки на конкретные правовые позиции ВС РФ
- Создавать документы в соответствии с процессуальными требованиями

### Архитектура системы

```
[Пользователь] → [Описание дела] → [RAG Система] → [Готовый документ]
                                    ↓
[Векторная БД] ← [40,000 решений ВС РФ] ← [PDF Парсер]
                                    ↓
[Gemini 2.5 Pro] ← [Релевантные дела] ← [Семантический поиск]
```

### Компоненты системы

#### 1. Модуль обработки данных
- **PDF парсер** - извлечение текста из судебных решений
- **JSON структуризатор** - преобразование в структурированный формат
- **Валидатор данных** - проверка качества извлеченной информации

#### 2. Векторная база знаний
- **ChromaDB** - хранение векторных представлений
- **SentenceTransformers** - создание эмбеддингов на русском языке
- **Индексация** - быстрый семантический поиск

#### 3. Модуль поиска (Retrieval)
- **Семантический поиск** - поиск по смыслу, не по ключевым словам
- **Ранжирование** - сортировка по релевантности
- **Фильтрация** - отбор топ-5 наиболее подходящих дел

#### 4. Модуль генерации (Generation)
- **Gemini 2.5 Pro** - генерация финальных документов
- **Промпт-инжиниринг** - создание качественных промптов
- **Шаблонизация** - структурирование выходных документов

### Требования к качеству

**Критерии успеха:**
- ✅ Высокая релевантность найденных судебных решений
- ✅ Качественная мотивировочная часть с ссылками на ВС РФ
- ✅ Соответствие процессуальным требованиям
- ✅ Готовность документов к подаче (с минимальной правкой)
- ✅ Время генерации < 30 секунд

**Оценка качества:** 9.5/10 (по мнению Gemini 2.5 Pro)

### Структура проекта

```
RAG-project/
├── src/                    # Исходный код
│   ├── rag_system/         # Основная RAG система
│   │   ├── __init__.py
│   │   └── legal_document_generator.py
│   ├── processors/         # Обработчики документов
│   │   ├── __init__.py
│   │   ├── data_processor.py
│   │   ├── gemini_chunker.py
│   │   └── chatgpt_chunker.py
│   ├── databases/          # Векторные базы данных
│   │   ├── __init__.py
│   │   ├── vector_database.py
│   │   └── simple_vector_db.py
│   ├── integrations/       # Интеграции с API
│   │   ├── __init__.py
│   │   └── gemini_integration.py
│   └── utils/              # Утилиты
│       ├── __init__.py
│       └── config.py
├── tests/                  # Тесты
│   ├── test_*.py
│   └── compare_chunking_models.py
├── scripts/                # Скрипты
│   ├── async_reindex.py
│   ├── reindex_with_improved_labeling.py
│   └── full_pipeline_test.py
├── docs/                   # Документация
├── data/                   # Данные
│   ├── pdfs/              # PDF документы
│   ├── json/              # Обработанные JSON
│   └── chroma_db/         # Векторная база
├── templates/              # HTML шаблоны
├── static/                # CSS стили
├── logs/                  # Логи
├── main.py                # Точка входа
├── setup.py               # Установка пакета
├── pyproject.toml         # Конфигурация проекта
├── requirements.txt       # Зависимости
└── README.md              # Документация
```

### Технологический стек

**Backend:**
- Python 3.9+
- PyMuPDF (fitz) - обработка PDF
- SentenceTransformers - векторизация
- ChromaDB - векторная база данных
- Google Generative AI - Gemini 2.5 Pro API

**Инфраструктура:**
- Локальное хранение данных (конфиденциальность)
- Облачное хранилище Google (опционально)
- REST API для интеграции

### Структура данных

#### JSON схема для судебных решений:
```json
{
  "metadata": {
    "case_number": "5-КГ25-89-К2",
    "court": "Верховный Суд РФ",
    "date": "2025-08-12",
    "judges": ["Асташов С.В.", "Киселёв А.П."]
  },
  "participants": {
    "plaintiff": "Ларицкий Владислав",
    "defendants": ["Сенин С.В.", "Хафизов А.Ш."]
  },
  "legal_analysis": {
    "supreme_court_reasoning": [
      {
        "thesis": "Правовая позиция ВС РФ...",
        "legal_norm": "ст. 807 ГК РФ"
      }
    ]
  },
  "consolidated_text_for_rag": "Объединенный текст для поиска..."
}
```

### API интерфейс

```python
def generate_legal_document(
    case_description: str,
    document_type: str = "исковое заявление",
    court_type: str = "районный суд"
) -> str:
    """
    Генерирует юридический документ на основе описания дела
    
    Args:
        case_description: Описание фактических обстоятельств
        document_type: Тип документа (иск, апелляция, кассация)
        court_type: Тип суда (районный, арбитражный)
    
    Returns:
        Готовый юридический документ
    """
```

### Безопасность и конфиденциальность

- Все данные хранятся локально
- API ключи защищены
- Логирование запросов без персональных данных
- Возможность работы в офлайн режиме

### Ограничения

- Требует качественной предобработки PDF документов
- Зависит от доступности API Gemini 2.5 Pro
- Необходима финальная проверка юристом
- Ограничена судебной практикой ВС РФ

## Установка и запуск

```bash
# Клонирование репозитория
git clone <repository_url>
cd RAG-project

# Создание виртуального окружения
python -m venv venv
venv\Scripts\activate  # Windows
# source venv/bin/activate  # Linux/Mac

# Установка зависимостей
pip install -r requirements.txt

# Настройка API ключей (создать .env файл)
GEMINI_API_KEY=your_api_key_here

# Тестирование системы
python quick_test.py

# Запуск полного тестирования
python scripts/full_pipeline_test.py

# Запуск API сервера
python main.py
```

## Тестирование компонентов

### Быстрый тест системы
```bash
python quick_test.py
```

### Полное тестирование пайплайна
```bash
python scripts/full_pipeline_test.py
```

### Тестирование отдельных модулей
```bash
# Тест обработки данных
python tests/test_data_processor.py

# Тест векторной базы данных
python tests/test_vector_db.py

# Асинхронная переиндексация (рекомендуется для больших корпусов)
python scripts/async_reindex.py

# Тестирование асинхронной обработки
python tests/test_async_processing.py
```

## Использование

```python
from rag_system import LegalDocumentGenerator

generator = LegalDocumentGenerator()

# Генерация искового заявления
case_facts = """
Истец выдал заем ответчику в размере 1,000,000 рублей. 
Ответчик написал расписку, но деньги не вернул. 
Теперь утверждает, что займа не было.
"""

document = generator.generate_document(
    case_description=case_facts,
    document_type="исковое заявление"
)

print(document)
```

## Лицензия

Проект разрабатывается для внутреннего использования юридической практики.

## Формирование векторной базы

1) Скопируйте PDF в папку `data/pdfs`  
2) Запустите обработку и создание JSON:
```bash
venv\Scripts\activate
python scripts/full_pipeline_test.py  # создаст JSON и соберет БД (и проверит поиск)
```
Альтернатива (быстрее, без тяжелой модели):
```bash
python quick_test.py  # использует упрощенную TF-IDF БД
```

## Запуск веб-интерфейса

1) Убедитесь, что `.env` содержит ключи:
```
GEMINI_API_KEY=...
OPENAI_API_KEY=...
```
2) Запуск:
```bash
venv\Scripts\activate
python main.py
```
3) Откройте в браузере: `http://localhost:8000/`  
Поле ввода — обстоятельства дела, select — тип документа. Нажмите «Сгенерировать документ».

## Полный тест всей системы
```bash
venv\Scripts\activate
python scripts/full_pipeline_test.py
```
Он выполняет: обработку PDF → JSON, сборку векторной БД (полной, при наличии) → поиск → микро-бенчмарк → отчет.

## Демо генерации через API провайдеров (CLI)
```bash
venv\Scripts\activate
python generate_demo.py
```
Скрипт найдет релевантные фрагменты и сгенерирует документ через Gemini; при ошибке — через OpenAI.

